<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Med Evaluation Annotation Tool</title>
  <style>
    * {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Microsoft YaHei", sans-serif;
      background-color: #f5f5f7;
      color: #222;
    }
    body {
      display: flex;
      flex-direction: column;
    }
    header {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background-color: #1f2933;
      color: #f9fafb;
    }
    .header-left, .header-right {
      display: flex;
      align-items: center;
    }
    .header-left span {
      margin-right: 16px;
    }
    .header-title {
      font-size: 18px;
      font-weight: 600;
      margin-right: 24px;
    }
    .header-counter {
      font-size: 14px;
      opacity: 0.9;
    }
    .header-right button {
      margin-left: 8px;
    }
    main {
      flex: 1 1 auto;
      display: flex;
      min-height: 0;
    }
    aside {
      flex: 0 0 260px;
      max-width: 320px;
      border-right: 1px solid #e0e0e0;
      background-color: #ffffff;
      overflow-y: auto;
      padding: 8px;
    }
    #case-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .case-item {
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      font-size: 13px;
    }
    .case-item:hover {
      background-color: #f0f4ff;
    }
    .case-item.active {
      background-color: #e0ebff;
      font-weight: 600;
    }
    .case-item .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
      background-color: #d0d0d0;
      flex-shrink: 0;
    }
    .case-item.completed .status-dot {
      background-color: #22c55e;
    }
    .case-item-title {
      flex: 1 1 auto;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    section#case-detail-panel {
      flex: 1 1 auto;
      padding: 12px 16px 40px 16px;
      overflow-y: auto;
      position: relative;
    }
    #case-title {
      margin: 0 0 4px 0;
      font-size: 20px;
    }
    #case-url {
      font-size: 13px;
      word-break: break-all;
    }
    #load-status {
      margin-top: 8px;
      font-size: 13px;
      color: #666;
    }
    .info-section {
      margin-top: 16px;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      padding: 12px 14px;
    }
    .info-section h3 {
      margin-top: 0;
      font-size: 15px;
      margin-bottom: 8px;
    }
    .info-section p {
      margin: 4px 0;
      font-size: 13px;
    }
    #steps-list {
      padding-left: 20px;
      margin: 4px 0;
    }
    #steps-list li {
      margin-bottom: 8px;
      font-size: 13px;
    }
    #steps-list .step-text-line {
      margin-bottom: 2px;
    }
    #steps-list .step-source {
      color: #555;
      font-style: italic;
      margin-left: 4px;
    }
    #steps-list .step-reason {
      display: block;
      color: #555;
      margin-top: 2px;
    }
    .step-rank-controls {
      margin-top: 4px;
      font-size: 12px;
      color: #374151;
    }
    .step-rank-label {
      margin-right: 4px;
      font-weight: 600;
    }
    .rank-option {
      margin-right: 6px;
    }
    #localisation-reference dl {
      margin: 0;
      font-size: 13px;
    }
    #localisation-reference dt {
      font-weight: 600;
    }
    #localisation-reference dd {
      margin: 0 0 4px 0;
    }
    #localisation-levels {
      font-size: 13px;
    }
    #localisation-levels .level-row {
      margin-bottom: 4px;
    }
    #localisation-levels .level-label {
      font-weight: 600;
      margin-right: 4px;
    }
    button {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #cbd5e1;
      background-color: #e5e7eb;
      color: #111827;
      font-size: 13px;
      cursor: pointer;
    }
    button:hover {
      background-color: #d1d5db;
    }
    button.primary {
      background-color: #2563eb;
      border-color: #1d4ed8;
      color: #f9fafb;
    }
    button.primary:hover {
      background-color: #1d4ed8;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #autosave-status {
      font-size: 12px;
      color: #e5e7eb;
      margin-left: 12px;
    }
    .field-group {
      margin-top: 10px;
      font-size: 13px;
    }
    .field-group label {
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }
    .field-group input[type="number"],
    .field-group select,
    .field-group textarea {
      width: 100%;
      padding: 4px 6px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
    }
    .field-group textarea {
      resize: vertical;
    }
    .radio-group-inline label {
      margin-right: 10px;
      font-weight: 400;
    }
    #json-load-warning {
      margin-top: 8px;
      font-size: 12px;
      color: #b91c1c;
    }
    #manual-load-container {
      margin-top: 8px;
      font-size: 13px;
    }
    #manual-load-container button {
      margin-top: 4px;
    }
    @media (max-width: 900px) {
      aside {
        flex: 0 0 200px;
      }
    }
    @media (max-width: 700px) {
      main {
        flex-direction: column;
      }
      aside {
        flex: 0 0 auto;
        max-height: 180px;
        border-right: none;
        border-bottom: 1px solid #e5e7eb;
      }
      section#case-detail-panel {
        padding-bottom: 200px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <span class="header-title">Med Evaluation Annotation Tool</span>
      <span class="header-counter" id="header-case-counter">No dataset loaded</span>
    </div>
    <div class="header-right">
      <button id="btn-prev-case">Previous case</button>
      <button id="btn-next-case">Next case</button>
      <button id="btn-open-eurorad" class="primary">Open Eurorad</button>
      <button id="btn-export-json">Export JSON</button>
      <button id="btn-clear-memory">Clear memory</button>
      <span id="autosave-status"></span>
    </div>
  </header>

  <main>
    <aside>
      <h3 style="margin: 4px 0 8px 4px; font-size: 14px;">Case list</h3>
      <ul id="case-list"></ul>
    </aside>
    <section id="case-detail-panel">
      <div id="case-info" class="info-section">
        <h2 id="case-title">Please load a JSON file to start.</h2>
        <p>URL:
          <a id="case-url" href="#" target="_blank" rel="noopener noreferrer"></a>
        </p>
        <p id="load-status">Step 1: click “Choose JSON file...” below and select your dataset (same structure as the example JSON).</p>
        <div id="manual-load-container">
          <p>You are running this tool from a web server (e.g. GitHub Pages). Please click the button below to select your local dataset JSON file (for example, <strong>example_1_items_simplified.json</strong>):</p>
          <button id="btn-manual-load-json">Choose JSON file...</button>
          <div id="json-load-warning"></div>
        </div>
      </div>

      <div class="info-section" id="case-annotations-section" style="display:none;">
        <h3>Case annotations</h3>
        <div class="field-group">
          <label for="difficulty-select">Difficulty:</label>
          <select id="difficulty-select">
            <option value="">-- select --</option>
            <option value="normal">normal</option>
            <option value="hard">hard</option>
            <option value="extrem hard">extrem hard</option>
          </select>
        </div>
        <div class="field-group">
          <label for="rarity-select">Rarity:</label>
          <select id="rarity-select">
            <option value="">-- select --</option>
            <option value="Common">Common</option>
            <option value="Rare">Rare</option>
            <option value="Extrem Rare">Extrem Rare</option>
          </select>
        </div>
        <div class="field-group">
          <label>Not ideal case, can be discarded.</label>
          <div class="radio-group-inline">
            <label><input type="radio" name="discard" value="true"> True</label>
            <label><input type="radio" name="discard" value="false"> False</label>
          </div>
        </div>
        <div class="field-group">
          <label for="red-flag-input">Harmful/Red-flag exams (something definitely to avoid in this case):</label>
          <textarea id="red-flag-input" rows="2" placeholder="Explicitly unsafe or should NOT be performed examinations."></textarea>
        </div>
        <div class="field-group">
          <label for="case-comment">Comment:</label>
          <textarea id="case-comment" rows="3" placeholder="Overall assessment of the case; if discard, explain why."></textarea>
        </div>
      </div>

      <div class="info-section" id="diagnostic-steps-section" style="display:none;">
        <h3>Diagnostic steps (read-only from JSON)</h3>
        <ol id="steps-list"></ol>
      </div>
      <div class="info-section" id="imaging-section" style="display:none;">
        <h3>Imaging examinations (preferred order)</h3>
        <div id="imaging-list"></div>
        <div id="imaging-warning" style="color:#b91c1c; font-size:12px; margin-top:4px; display:none;"></div>
      </div>

      <div class="info-section" id="localisation-section" style="display:none;">
        <h3>Rubric reference</h3>
        <div id="localisation-reference"></div>
        <hr style="margin: 10px 0;">
        <div id="localisation-levels"></div>
        <hr style="margin: 10px 0;">
        <div id="diagnosis-rubric"></div>
        <div class="field-group">
          <label>Is the Localisation rubric reasonable?</label>
          <div class="radio-group-inline">
            <label><input type="radio" name="localisation-ok" value="true"> True</label>
            <label><input type="radio" name="localisation-ok" value="false"> False</label>
          </div>
        </div>
        <div class="field-group">
          <label>Is the Diagnosis rubric reasonable?</label>
          <div class="radio-group-inline">
            <label><input type="radio" name="diagnosis-ok" value="true"> True</label>
            <label><input type="radio" name="diagnosis-ok" value="false"> False</label>
          </div>
        </div>
        <div class="field-group" id="localisation-comment-group" style="display:none;">
          <label for="localisation-comment">Localisation comment (required if false):</label>
          <textarea id="localisation-comment" rows="3" placeholder="Explain why the localisation rubric is incorrect."></textarea>
        </div>
        <div class="field-group" id="diagnosis-comment-group" style="display:none;">
          <label for="diagnosis-comment">Diagnosis comment (required if false):</label>
          <textarea id="diagnosis-comment" rows="3" placeholder="Explain why the diagnosis rubric is incorrect."></textarea>
        </div>
      </div>
    </section>
  </main>

  <input type="file" id="jsonFileInput" accept=".json,application/json" style="display:none;" />

  <script>
    (function () {
      "use strict";

      var DATASET_ID = "eurorad_example_1";
      var STORAGE_KEY = "eurorad_annotations_" + DATASET_ID + "_v2";

      var cases = [];
      var currentIndex = 0;
      var answersByCaseId = {};
      var euroradWindow = null;
      var autosaveInterval = 5000;
      var autosaveTimerStarted = false;
      var dirty = false;

      // DOM elements
      var headerCaseCounter = document.getElementById("header-case-counter");
      var autosaveStatus = document.getElementById("autosave-status");
      var caseListEl = document.getElementById("case-list");
      var caseTitleEl = document.getElementById("case-title");
      var caseUrlEl = document.getElementById("case-url");
      var loadStatusEl = document.getElementById("load-status");
      var manualLoadContainer = document.getElementById("manual-load-container");
      var jsonLoadWarning = document.getElementById("json-load-warning");
      var btnManualLoadJson = document.getElementById("btn-manual-load-json");

      var diagnosticStepsSection = document.getElementById("diagnostic-steps-section");
      var stepsListEl = document.getElementById("steps-list");
      var imagingSection = document.getElementById("imaging-section");
      var imagingListEl = document.getElementById("imaging-list");
      var imagingWarningEl = document.getElementById("imaging-warning");
      var caseAnnotationsSection = document.getElementById("case-annotations-section");

      var localisationSection = document.getElementById("localisation-section");
      var localisationReferenceEl = document.getElementById("localisation-reference");
      var localisationLevelsEl = document.getElementById("localisation-levels");
      var diagnosisRubricEl = document.getElementById("diagnosis-rubric");

      var difficultySelect = document.getElementById("difficulty-select");
      var raritySelect = document.getElementById("rarity-select");
      var discardRadioEls = document.getElementsByName("discard");
      var redFlagInput = document.getElementById("red-flag-input");
      var caseCommentEl = document.getElementById("case-comment");
      var localisationCommentGroup = document.getElementById("localisation-comment-group");
      var diagnosisCommentGroup = document.getElementById("diagnosis-comment-group");
      var localisationCommentEl = document.getElementById("localisation-comment");
      var diagnosisCommentEl = document.getElementById("diagnosis-comment");
      var localisationOkRadioEls = document.getElementsByName("localisation-ok");
      var diagnosisOkRadioEls = document.getElementsByName("diagnosis-ok");

      var btnPrevCase = document.getElementById("btn-prev-case");
      var btnNextCase = document.getElementById("btn-next-case");
      var btnOpenEurorad = document.getElementById("btn-open-eurorad");
      var btnExportJson = document.getElementById("btn-export-json");
      var btnClearMemory = document.getElementById("btn-clear-memory");
      var jsonFileInput = document.getElementById("jsonFileInput");

      function formatTime(date) {
        function pad(n) { return n < 10 ? "0" + n : "" + n; }
        return pad(date.getHours()) + ":" + pad(date.getMinutes()) + ":" + pad(date.getSeconds());
      }

      function extractCaseId(caseUrl, index) {
        if (typeof caseUrl === "string") {
          var match = caseUrl.match(/(\d+)(?:\/)?$/);
          if (match && match[1]) {
            return match[1];
          }
          return caseUrl;
        }
        return "case_" + index;
      }

      function normalizeBoolean(val) {
        if (val === true || val === false) {
          return val;
        }
        if (val === "true") {
          return true;
        }
        if (val === "false") {
          return false;
        }
        return undefined;
      }

      function normalizeStepPriority(val) {
        if (typeof val === "string") {
          var lower = val.toLowerCase();
          if (lower === "essential" || lower === "optional" || lower === "unnecessary") {
            return lower;
          }
          if (lower === "true" || lower === "yes") {
            return "essential";
          }
          if (lower === "false" || lower === "no") {
            return "unnecessary";
          }
        }
        if (val === true) {
          return "essential";
        }
        if (val === false) {
          return "unnecessary";
        }
        return undefined;
      }

      function formatMetaInfoText(meta) {
        if (!meta) return "No meta info provided.";
        if (typeof meta === "string") return meta;
        if (typeof meta !== "object") return String(meta);
        var parts = [];
        if (meta.modality) parts.push("Modality: " + meta.modality);
        if (meta.acquisition) parts.push("Acquisition: " + meta.acquisition);
        if (meta.imaged_region) parts.push("Region: " + meta.imaged_region);
        if (meta.body_part) parts.push("Body part: " + meta.body_part);
        return parts.length > 0 ? parts.join(" | ") : "No meta info provided.";
      }

      function hasCompleteImagingAnnotations(entry, caseObj) {
        var exams = (caseObj && caseObj.imaging_examinations && Array.isArray(caseObj.imaging_examinations)) ? caseObj.imaging_examinations : [];
        if (exams.length === 0) return true;
        var orderMap = entry && entry.imaging_preferred_order;
        var metaMap = entry && entry.imaging_meta_info_ok;
        var usedOrders = {};
        for (var i = 0; i < exams.length; i++) {
          var key = i + 1;
          var orderVal = orderMap ? parseInt(orderMap[key], 10) : NaN;
          var hasOrder = orderMap && !isNaN(orderVal);
          if (hasOrder) {
            if (usedOrders[orderVal]) {
              return false;
            }
            usedOrders[orderVal] = true;
          }
          var hasMeta = metaMap && typeof metaMap[key] === "boolean";
          if (!hasOrder || !hasMeta) {
            return false;
          }
        }
        return true;
      }

      function findCaseById(caseId) {
        if (!cases || cases.length === 0) return null;
        for (var i = 0; i < cases.length; i++) {
          if (extractCaseId(cases[i].case_url, i) === caseId) {
            return cases[i];
          }
        }
        return null;
      }

      function isCaseComplete(entry, caseObj) {
        return !!entry &&
          typeof entry.localisation_rubric_ok === "boolean" &&
          typeof entry.diagnosis_rubric_ok === "boolean" &&
          typeof entry.rarity === "string" &&
          entry.rarity.trim() !== "" &&
          hasCompleteImagingAnnotations(entry, caseObj);
      }

      function updateRubricCommentVisibility() {
        var locFalse = false;
        for (var k = 0; k < localisationOkRadioEls.length; k++) {
          if (localisationOkRadioEls[k].checked && localisationOkRadioEls[k].value === "false") {
            locFalse = true;
            break;
          }
        }
        if (localisationCommentGroup) {
          localisationCommentGroup.style.display = locFalse ? "block" : "none";
          if (!locFalse) {
            localisationCommentEl.value = "";
          }
        }

        var diagFalse = false;
        for (var d = 0; d < diagnosisOkRadioEls.length; d++) {
          if (diagnosisOkRadioEls[d].checked && diagnosisOkRadioEls[d].value === "false") {
            diagFalse = true;
            break;
          }
        }
        if (diagnosisCommentGroup) {
          diagnosisCommentGroup.style.display = diagFalse ? "block" : "none";
          if (!diagFalse) {
            diagnosisCommentEl.value = "";
          }
        }
      }

      function loadFromLocalStorage() {
        try {
          var raw = window.localStorage.getItem(STORAGE_KEY);
          if (!raw) return;
          var parsed = JSON.parse(raw);
          if (parsed && parsed.answers && Array.isArray(parsed.answers)) {
            var map = {};
          for (var i = 0; i < parsed.answers.length; i++) {
            var a = parsed.answers[i];
            if (a && a.case_id) {
              var copy = {};
              if (typeof a.difficulty !== "undefined") {
                copy.difficulty = a.difficulty;
              }
              if (typeof a.rarity !== "undefined") {
                copy.rarity = a.rarity;
              }
              if (typeof a.discard !== "undefined") {
                var discardVal = normalizeBoolean(a.discard);
                if (typeof discardVal === "boolean") {
                  copy.discard = discardVal;
                }
              }
              if (typeof a.red_flag_exam !== "undefined") {
                copy.red_flag_exam = a.red_flag_exam;
              }
              if (typeof a.comment !== "undefined") {
                copy.comment = a.comment;
              }
              if (a.steps_essential) {
                var normalizedSteps = {};
                for (var idx in a.steps_essential) {
                  if (!Object.prototype.hasOwnProperty.call(a.steps_essential, idx)) continue;
                  var priorityVal = normalizeStepPriority(a.steps_essential[idx]);
                  if (priorityVal) {
                    normalizedSteps[idx] = priorityVal;
                  }
                }
                if (Object.keys(normalizedSteps).length > 0) {
                  copy.steps_essential = normalizedSteps;
                }
              }
              if (a.imaging_preferred_order) {
                var normalizedOrders = {};
                for (var ord in a.imaging_preferred_order) {
                  if (!Object.prototype.hasOwnProperty.call(a.imaging_preferred_order, ord)) continue;
                  var numVal = parseInt(a.imaging_preferred_order[ord], 10);
                  if (!isNaN(numVal)) {
                    normalizedOrders[ord] = numVal;
                  }
                }
                if (Object.keys(normalizedOrders).length > 0) {
                  copy.imaging_preferred_order = normalizedOrders;
                }
              }
              if (a.imaging_meta_info_comment) {
                var normalizedMetaComments = {};
                for (var cKey in a.imaging_meta_info_comment) {
                  if (!Object.prototype.hasOwnProperty.call(a.imaging_meta_info_comment, cKey)) continue;
                  var parsedCKey = parseInt(cKey, 10);
                  var finalCKey = isNaN(parsedCKey) ? cKey : parsedCKey;
                  if (typeof a.imaging_meta_info_comment[cKey] === "string") {
                    normalizedMetaComments[finalCKey] = a.imaging_meta_info_comment[cKey];
                  }
                }
                if (Object.keys(normalizedMetaComments).length > 0) {
                  copy.imaging_meta_info_comment = normalizedMetaComments;
                }
              }
              if (a.imaging_meta_info_ok) {
                var normalizedMeta = {};
                for (var metaKey in a.imaging_meta_info_ok) {
                  if (!Object.prototype.hasOwnProperty.call(a.imaging_meta_info_ok, metaKey)) continue;
                  var boolVal = normalizeBoolean(a.imaging_meta_info_ok[metaKey]);
                  var parsedKey = parseInt(metaKey, 10);
                  var finalKey = isNaN(parsedKey) ? metaKey : parsedKey;
                  if (typeof boolVal === "boolean") {
                    normalizedMeta[finalKey] = boolVal;
                  }
                }
                if (Object.keys(normalizedMeta).length > 0) {
                  copy.imaging_meta_info_ok = normalizedMeta;
                }
              }
              if (typeof a.localisation_rubric_ok !== "undefined") {
                copy.localisation_rubric_ok = a.localisation_rubric_ok;
              }
              if (typeof a.diagnosis_rubric_ok !== "undefined") {
                copy.diagnosis_rubric_ok = a.diagnosis_rubric_ok;
              }
              if (typeof a.localisation_comment !== "undefined") {
                copy.localisation_comment = a.localisation_comment;
              }
              if (typeof a.diagnosis_comment !== "undefined") {
                copy.diagnosis_comment = a.diagnosis_comment;
              }
              map[a.case_id] = copy;
            }
          }
            answersByCaseId = map;
          }
          if (typeof parsed.last_case_index === "number" && parsed.last_case_index >= 0) {
            currentIndex = parsed.last_case_index;
          }
        } catch (e) {
          console.error("Failed to read localStorage:", e);
        }
      }

      function saveToLocalStorage() {
        try {
          var answersArray = [];
          for (var caseId in answersByCaseId) {
            if (!Object.prototype.hasOwnProperty.call(answersByCaseId, caseId)) continue;
            var entry = answersByCaseId[caseId];
            var out = { case_id: caseId };
            if (typeof entry.difficulty !== "undefined") {
              out.difficulty = entry.difficulty;
            }
            if (typeof entry.rarity !== "undefined") {
              out.rarity = entry.rarity;
            }
            if (typeof entry.discard !== "undefined") {
              out.discard = entry.discard;
            }
            if (typeof entry.red_flag_exam !== "undefined") {
              out.red_flag_exam = entry.red_flag_exam;
            }
            if (typeof entry.comment !== "undefined") {
              out.comment = entry.comment;
            }
            if (entry.steps_essential) {
              out.steps_essential = entry.steps_essential;
            }
            if (entry.imaging_preferred_order) {
              out.imaging_preferred_order = entry.imaging_preferred_order;
            }
            if (entry.imaging_meta_info_ok) {
              out.imaging_meta_info_ok = entry.imaging_meta_info_ok;
            }
            if (entry.imaging_meta_info_comment) {
              out.imaging_meta_info_comment = entry.imaging_meta_info_comment;
            }
            if (typeof entry.localisation_rubric_ok !== "undefined") {
              out.localisation_rubric_ok = entry.localisation_rubric_ok;
            }
            if (typeof entry.diagnosis_rubric_ok !== "undefined") {
              out.diagnosis_rubric_ok = entry.diagnosis_rubric_ok;
            }
            if (typeof entry.localisation_comment !== "undefined") {
              out.localisation_comment = entry.localisation_comment;
            }
            if (typeof entry.diagnosis_comment !== "undefined") {
              out.diagnosis_comment = entry.diagnosis_comment;
            }
            answersArray.push(out);
          }
          var payload = {
            dataset_id: DATASET_ID,
            answers: answersArray,
            last_updated: new Date().toISOString(),
            last_case_index: currentIndex
          };
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
          autosaveStatus.textContent = "Auto-saved at " + formatTime(new Date());
        } catch (e) {
          console.error("Failed to write to localStorage:", e);
          autosaveStatus.textContent = "Auto-save failed (please check browser settings).";
        }
      }

      function markDirty() {
        dirty = true;
      }

      function autoSaveTick() {
        if (!dirty) return;
        saveToLocalStorage();
        dirty = false;
      }

      function buildCaseList() {
        caseListEl.innerHTML = "";
        for (var i = 0; i < cases.length; i++) {
          var c = cases[i];
          var caseId = extractCaseId(c.case_url, i);
          var li = document.createElement("li");
          li.className = "case-item";
          li.setAttribute("data-index", String(i));
          li.setAttribute("data-case-id", caseId);

          var dot = document.createElement("div");
          dot.className = "status-dot";
          li.appendChild(dot);

          var label = document.createElement("div");
          label.className = "case-item-title";
          var indexLabel = (i + 1) + ". ";
          var titleText = c.case_title || caseId;
          label.textContent = indexLabel + titleText;
          li.appendChild(label);

          li.addEventListener("click", (function (idx) {
            return function () {
              switchCase(idx, true);
            };
          })(i));

          caseListEl.appendChild(li);
        }
        refreshCaseListCompletion();
        updateHeaderCounter();
      }

      function refreshCaseListCompletion() {
        var items = caseListEl.querySelectorAll(".case-item");
        for (var i = 0; i < items.length; i++) {
          var li = items[i];
          var caseId = li.getAttribute("data-case-id");
          var answer = answersByCaseId[caseId];
          var caseObj = cases[i];
          if (isCaseComplete(answer, caseObj)) {
            li.classList.add("completed");
          } else {
            li.classList.remove("completed");
          }
          if (i === currentIndex) {
            li.classList.add("active");
          } else {
            li.classList.remove("active");
          }
        }
      }

      function updateHeaderCounter() {
        if (!cases || cases.length === 0) {
          headerCaseCounter.textContent = "No dataset loaded";
          return;
        }
        var currentNumber = currentIndex + 1;
        headerCaseCounter.textContent = "Case " + currentNumber + " / " + cases.length;
      }

      function renderDiagnosticSteps(caseObj, caseId) {
        var ds = caseObj.diagnostic_steps || {};
        var steps = (ds.steps && Array.isArray(ds.steps)) ? ds.steps : [];
        if (!steps || steps.length === 0) {
          diagnosticStepsSection.style.display = "none";
          stepsListEl.innerHTML = "";
          return;
        }
        diagnosticStepsSection.style.display = "block";
        stepsListEl.innerHTML = "";
        var saved = answersByCaseId[caseId];
        var savedEssential = (saved && saved.steps_essential) ? saved.steps_essential : {};

        for (var i = 0; i < steps.length; i++) {
          var step = steps[i];
          var li = document.createElement("li");

          var textLine = document.createElement("div");
          textLine.className = "step-text-line";
          var textSpan = document.createElement("span");
          textSpan.textContent = step.step || "";
          textLine.appendChild(textSpan);

          if (step.source) {
            var sourceSpan = document.createElement("span");
            sourceSpan.className = "step-source";
            sourceSpan.textContent = " [" + step.source + "]";
            textLine.appendChild(sourceSpan);
          }
          li.appendChild(textLine);

          if (step.reason) {
            var reasonSpan = document.createElement("span");
            reasonSpan.className = "step-reason";
            reasonSpan.textContent = step.reason;
            li.appendChild(reasonSpan);
          }

          var essentialDiv = document.createElement("div");
          essentialDiv.className = "step-rank-controls";
          var labelSpan = document.createElement("span");
          labelSpan.className = "step-rank-label";
          labelSpan.textContent = "Step importance:";
          essentialDiv.appendChild(labelSpan);

          var savedVal = undefined;
          var stepKeyPrimary = i + 1;
          var stepKeyLegacy = i;
          if (savedEssential && Object.prototype.hasOwnProperty.call(savedEssential, stepKeyPrimary)) {
            savedVal = normalizeStepPriority(savedEssential[stepKeyPrimary]);
          } else if (savedEssential && Object.prototype.hasOwnProperty.call(savedEssential, stepKeyLegacy)) {
            savedVal = normalizeStepPriority(savedEssential[stepKeyLegacy]);
          }
          if (!savedVal && typeof step.priority !== "undefined" && step.priority !== "") {
            savedVal = normalizeStepPriority(step.priority);
          }
          if (!savedVal && typeof step.essential !== "undefined" && step.essential !== "") {
            savedVal = normalizeStepPriority(step.essential);
          }

          [
            { value: "essential", label: "Essential (must-to-have)" },
            { value: "optional", label: "Optional (nice-to-have)" },
            { value: "unnecessary", label: "Unnecessary" }
          ].forEach(function (opt) {
            var optLabel = document.createElement("label");
            optLabel.className = "rank-option";
            var radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "step-priority-" + caseId + "-" + i;
            radio.value = opt.value;

            if (savedVal && savedVal === opt.value) {
              radio.checked = true;
            }

            radio.addEventListener("change", function () {
              updateAnswerFromForm();
            });

            optLabel.appendChild(radio);
            optLabel.appendChild(document.createTextNode(" " + opt.label));
            essentialDiv.appendChild(optLabel);
          });

          li.appendChild(essentialDiv);
          stepsListEl.appendChild(li);
        }
      }

      function renderImagingExaminations(caseObj, caseId) {
        var exams = (caseObj.imaging_examinations && Array.isArray(caseObj.imaging_examinations)) ? caseObj.imaging_examinations : [];
        if (!exams || exams.length === 0) {
          imagingSection.style.display = "none";
          imagingListEl.innerHTML = "";
          if (imagingWarningEl) {
            imagingWarningEl.style.display = "none";
            imagingWarningEl.textContent = "";
          }
          return;
        }
        imagingSection.style.display = "block";
        imagingListEl.innerHTML = "";
        if (imagingWarningEl) {
          imagingWarningEl.style.display = "none";
          imagingWarningEl.textContent = "";
        }

        var saved = answersByCaseId[caseId];
        var savedOrders = (saved && saved.imaging_preferred_order) ? saved.imaging_preferred_order : {};
        var savedMetaInfo = (saved && saved.imaging_meta_info_ok) ? saved.imaging_meta_info_ok : {};
        var savedMetaComments = (saved && saved.imaging_meta_info_comment) ? saved.imaging_meta_info_comment : {};
        var maxOrder = exams.length;

        for (var i = 0; i < exams.length; i++) {
          var exam = exams[i];
          var wrapper = document.createElement("div");
          wrapper.className = "field-group";

          var label = document.createElement("label");
          var figureLabel = exam.figure ? exam.figure + ": " : "";
          label.textContent = figureLabel + (exam.modality || "Imaging examination");
          wrapper.appendChild(label);

          var metaInfoDisplay = document.createElement("div");
          metaInfoDisplay.style.fontSize = "12px";
          metaInfoDisplay.style.color = "#374151";
          metaInfoDisplay.style.marginTop = "4px";
          metaInfoDisplay.textContent = "Meta info: " + formatMetaInfoText(exam.meta_info);
          wrapper.appendChild(metaInfoDisplay);

          var select = document.createElement("select");
          select.name = "imaging-order-" + caseId + "-" + i;

          var emptyOpt = document.createElement("option");
          emptyOpt.value = "";
          emptyOpt.textContent = "-- select order --";
          select.appendChild(emptyOpt);

          for (var order = 1; order <= maxOrder; order++) {
            var opt = document.createElement("option");
            opt.value = String(order);
            opt.textContent = String(order);
            select.appendChild(opt);
          }

          var savedVal = undefined;
          var keyPrimary = i + 1;
          var keyLegacy = i;
          if (savedOrders && Object.prototype.hasOwnProperty.call(savedOrders, keyPrimary)) {
            savedVal = savedOrders[keyPrimary];
          } else if (savedOrders && Object.prototype.hasOwnProperty.call(savedOrders, keyLegacy)) {
            savedVal = savedOrders[keyLegacy];
          } else if (typeof exam.preferred_order !== "undefined" && exam.preferred_order !== "") {
            savedVal = exam.preferred_order;
          }
          if (typeof savedVal !== "undefined" && savedVal !== null && savedVal !== "") {
            select.value = String(savedVal);
          }

          select.addEventListener("change", function () {
            updateAnswerFromForm();
          });

          wrapper.appendChild(select);

          var metaDiv = document.createElement("div");
          metaDiv.className = "step-rank-controls";
          var metaLabel = document.createElement("span");
          metaLabel.className = "step-rank-label";
          metaLabel.textContent = "Meta info correct?";
          metaDiv.appendChild(metaLabel);

          var savedMetaVal = undefined;
          if (savedMetaInfo && Object.prototype.hasOwnProperty.call(savedMetaInfo, keyPrimary)) {
            savedMetaVal = normalizeBoolean(savedMetaInfo[keyPrimary]);
          } else if (savedMetaInfo && Object.prototype.hasOwnProperty.call(savedMetaInfo, keyLegacy)) {
            savedMetaVal = normalizeBoolean(savedMetaInfo[keyLegacy]);
          }

          var metaCommentWrapper = document.createElement("div");
          metaCommentWrapper.style.marginTop = "4px";
          metaCommentWrapper.style.display = (savedMetaVal === false) ? "block" : "none";
          var metaCommentLabel = document.createElement("div");
          metaCommentLabel.style.fontSize = "12px";
          metaCommentLabel.style.fontWeight = "600";
          metaCommentLabel.textContent = "Comment (required if incorrect):";
          metaCommentWrapper.appendChild(metaCommentLabel);
          var metaCommentArea = document.createElement("textarea");
          metaCommentArea.name = "imaging-metainfo-comment-" + caseId + "-" + i;
          metaCommentArea.rows = 2;
          metaCommentArea.style.width = "100%";
          metaCommentArea.style.fontSize = "12px";
          var savedMetaComment = undefined;
          if (savedMetaComments && Object.prototype.hasOwnProperty.call(savedMetaComments, keyPrimary)) {
            savedMetaComment = savedMetaComments[keyPrimary];
          } else if (savedMetaComments && Object.prototype.hasOwnProperty.call(savedMetaComments, keyLegacy)) {
            savedMetaComment = savedMetaComments[keyLegacy];
          }
          if (typeof savedMetaComment === "string") {
            metaCommentArea.value = savedMetaComment;
          }
          metaCommentArea.addEventListener("input", function () {
            updateAnswerFromForm();
          });
          metaCommentWrapper.appendChild(metaCommentArea);

          [
            { value: "true", label: "True" },
            { value: "false", label: "False" }
          ].forEach(function (opt) {
            var optLabel = document.createElement("label");
            optLabel.className = "rank-option";
            var radio = document.createElement("input");
            radio.type = "radio";
            radio.name = "imaging-metainfo-" + caseId + "-" + i;
            radio.value = opt.value;
            if (typeof savedMetaVal === "boolean" && savedMetaVal === (opt.value === "true")) {
              radio.checked = true;
            }
            (function (wrapperRef, areaRef) {
              radio.addEventListener("change", function () {
                var isFalse = this.value === "false";
                wrapperRef.style.display = isFalse ? "block" : "none";
                if (!isFalse) {
                  areaRef.value = "";
                }
                updateAnswerFromForm();
              });
            })(metaCommentWrapper, metaCommentArea);
            optLabel.appendChild(radio);
            optLabel.appendChild(document.createTextNode(" " + opt.label));
            metaDiv.appendChild(optLabel);
          });

          wrapper.appendChild(metaDiv);
          wrapper.appendChild(metaCommentWrapper);
          imagingListEl.appendChild(wrapper);
        }
      }

      function renderGenericRubric(rubricEntry, container, titleText) {
        container.innerHTML = "";
        var heading = document.createElement("div");
        heading.className = "level-row";
        var headingLabel = document.createElement("span");
        headingLabel.className = "level-label";
        headingLabel.textContent = titleText + ": ";
        heading.appendChild(headingLabel);
        container.appendChild(heading);

        if (!rubricEntry) {
          var missing = document.createElement("div");
          missing.textContent = "No rubric data.";
          container.appendChild(missing);
          return;
        }

        if (typeof rubricEntry.reference_answer !== "undefined") {
          var refDiv = document.createElement("div");
          refDiv.style.margin = "4px 0";
          var refLabel = document.createElement("span");
          refLabel.style.fontWeight = "600";
          refLabel.textContent = "Reference answer: ";
          refDiv.appendChild(refLabel);
          var refContent = document.createElement("span");
          if (Array.isArray(rubricEntry.reference_answer)) {
            refContent.textContent = rubricEntry.reference_answer.join(" | ");
          } else {
            refContent.textContent = rubricEntry.reference_answer;
          }
          refDiv.appendChild(refContent);
          container.appendChild(refDiv);
        }

        var levels = ["3", "2", "1", "0"];
        for (var i = 0; i < levels.length; i++) {
          var levelKey = levels[i];
          if (typeof rubricEntry[levelKey] !== "undefined") {
            var row = document.createElement("div");
            row.className = "level-row";
            var labelSpan = document.createElement("span");
            labelSpan.className = "level-label";
            labelSpan.textContent = levelKey + " points: ";
            row.appendChild(labelSpan);
            var textSpan = document.createElement("span");
            textSpan.textContent = rubricEntry[levelKey];
            row.appendChild(textSpan);
            container.appendChild(row);
          }
        }
      }

      function renderLocalisationRubric(caseObj) {
        localisationSection.style.display = "block";
        localisationReferenceEl.innerHTML = "";
        localisationLevelsEl.innerHTML = "";
        diagnosisRubricEl.innerHTML = "";

        var rubricAll = caseObj.rubric_0_to_3 || {};
        var rubric = rubricAll && rubricAll.Localisation;
        if (!rubric) {
          localisationReferenceEl.textContent = "No Localisation rubric in this case JSON.";
        } else {
          var title = document.createElement("div");
          title.className = "level-row";
          var titleLabel = document.createElement("span");
          titleLabel.className = "level-label";
          titleLabel.textContent = "Localization rubric:";
          title.appendChild(titleLabel);
          localisationReferenceEl.appendChild(title);

          var ref = rubric.reference_answer;
          if (ref && typeof ref === "object") {
            var dl = document.createElement("dl");

            if (typeof ref.Laterality !== "undefined") {
              var dt1 = document.createElement("dt");
              dt1.textContent = "Laterality:";
              dl.appendChild(dt1);
              var dd1 = document.createElement("dd");
              dd1.textContent = ref.Laterality;
              dl.appendChild(dd1);
            }
            if (typeof ref["Organ/Region"] !== "undefined") {
              var dt2 = document.createElement("dt");
              dt2.textContent = "Organ/Region:";
              dl.appendChild(dt2);
              var dd2 = document.createElement("dd");
              dd2.textContent = ref["Organ/Region"];
              dl.appendChild(dd2);
            }
            if (typeof ref["Specific Substructure/Segment"] !== "undefined") {
              var dt3 = document.createElement("dt");
              dt3.textContent = "Specific Substructure/Segment:";
              dl.appendChild(dt3);
              var dd3 = document.createElement("dd");
              dd3.textContent = ref["Specific Substructure/Segment"];
              dl.appendChild(dd3);
            }

            localisationReferenceEl.appendChild(dl);
          }

          var levels = ["3", "2", "1", "0"];
          for (var i = 0; i < levels.length; i++) {
            var levelKey = levels[i];
            if (typeof rubric[levelKey] !== "undefined") {
              var row = document.createElement("div");
              row.className = "level-row";
              var labelSpan = document.createElement("span");
              labelSpan.className = "level-label";
              labelSpan.textContent = levelKey + " points: ";
              row.appendChild(labelSpan);
              var textSpan = document.createElement("span");
              textSpan.textContent = rubric[levelKey];
              row.appendChild(textSpan);
              localisationLevelsEl.appendChild(row);
            }
          }
        }

        renderGenericRubric(rubricAll && rubricAll.Diagnosis, diagnosisRubricEl, "Diagnosis rubric");
      }

      function updateAnswerFromForm() {
        if (!cases || cases.length === 0) return;
        var caseObj = cases[currentIndex];
        var caseId = extractCaseId(caseObj.case_url, currentIndex);

        var entry = answersByCaseId[caseId] || {};

        updateRubricCommentVisibility();

        // difficulty
        if (difficultySelect.value && difficultySelect.value !== "") {
          entry.difficulty = difficultySelect.value;
        } else {
          delete entry.difficulty;
        }

        // rarity
        if (raritySelect.value && raritySelect.value !== "") {
          entry.rarity = raritySelect.value;
        } else {
          delete entry.rarity;
        }

        // discard
        var discardVal;
        for (var dis = 0; dis < discardRadioEls.length; dis++) {
          if (discardRadioEls[dis].checked) {
            discardVal = normalizeBoolean(discardRadioEls[dis].value);
            break;
          }
        }
        if (typeof discardVal === "boolean") {
          entry.discard = discardVal;
        } else {
          delete entry.discard;
        }

        // red flag exam
        var redFlagVal = redFlagInput.value;
        if (redFlagVal && redFlagVal.trim() !== "") {
          entry.red_flag_exam = redFlagVal;
        } else {
          delete entry.red_flag_exam;
        }

        // comment
        var commentVal = caseCommentEl.value;
        if (commentVal && commentVal.trim() !== "") {
          entry.comment = commentVal;
        } else {
          delete entry.comment;
        }

        // steps_essential
        var ds = caseObj.diagnostic_steps || {};
        var steps = (ds.steps && Array.isArray(ds.steps)) ? ds.steps : [];
        if (steps.length > 0) {
          var stepsEssential = {};
        for (var i = 0; i < steps.length; i++) {
          var groupName = "step-priority-" + caseId + "-" + i;
          var radios = stepsListEl.querySelectorAll('input[name="' + groupName + '"]');
          for (var j = 0; j < radios.length; j++) {
            var r = radios[j];
            if (r.checked) {
              var priorityVal = normalizeStepPriority(r.value);
              if (priorityVal) {
                stepsEssential[i + 1] = priorityVal;
              }
              break;
            }
          }
          }
          if (Object.keys(stepsEssential).length > 0) {
            entry.steps_essential = stepsEssential;
          } else {
            delete entry.steps_essential;
          }
        }

        // imaging preferred order
        var exams = (caseObj.imaging_examinations && Array.isArray(caseObj.imaging_examinations)) ? caseObj.imaging_examinations : [];
        if (exams.length > 0) {
          var preferredOrder = {};
          var metaInfoOk = {};
          var metaInfoComments = {};
          var orderCounts = {};
          var duplicateOrders = {};
          for (var e = 0; e < exams.length; e++) {
            var select = imagingListEl.querySelector('select[name="imaging-order-' + caseId + '-' + e + '"]');
            if (select && select.value !== "") {
              var orderVal = parseInt(select.value, 10);
              if (!isNaN(orderVal)) {
                preferredOrder[e + 1] = orderVal;
                if (orderCounts[orderVal]) {
                  duplicateOrders[orderVal] = true;
                } else {
                  orderCounts[orderVal] = 1;
                }
              }
            }
            var metaRadios = imagingListEl.querySelectorAll('input[name="imaging-metainfo-' + caseId + '-' + e + '"]');
            var metaVal = null;
            for (var mr = 0; mr < metaRadios.length; mr++) {
              if (metaRadios[mr].checked) {
                metaVal = normalizeBoolean(metaRadios[mr].value);
                if (typeof metaVal === "boolean") {
                  metaInfoOk[e + 1] = metaVal;
                }
                break;
              }
            }
            var metaCommentEl = imagingListEl.querySelector('textarea[name="imaging-metainfo-comment-' + caseId + '-' + e + '"]');
            if (metaVal === false && metaCommentEl && metaCommentEl.value.trim() !== "") {
              metaInfoComments[e + 1] = metaCommentEl.value;
            }
          }
          if (Object.keys(preferredOrder).length > 0) {
            entry.imaging_preferred_order = preferredOrder;
          } else {
            delete entry.imaging_preferred_order;
          }
          if (Object.keys(metaInfoOk).length > 0) {
            entry.imaging_meta_info_ok = metaInfoOk;
          } else {
            delete entry.imaging_meta_info_ok;
          }
          if (Object.keys(metaInfoComments).length > 0) {
            entry.imaging_meta_info_comment = metaInfoComments;
          } else {
            delete entry.imaging_meta_info_comment;
          }
        } else {
          delete entry.imaging_preferred_order;
          delete entry.imaging_meta_info_ok;
          delete entry.imaging_meta_info_comment;
        }

        // warn on duplicate imaging orders
        var duplicateKeys = Object.keys(duplicateOrders || {});
        if (imagingWarningEl) {
          if (duplicateKeys.length > 0) {
            imagingWarningEl.style.display = "block";
            imagingWarningEl.textContent = "Duplicate preferred order numbers: " + duplicateKeys.join(", ") + ". Please assign unique orders.";
          } else {
            imagingWarningEl.style.display = "none";
            imagingWarningEl.textContent = "";
          }
        }

        // Localisation rubric OK
        var locValue = null;
        for (var k = 0; k < localisationOkRadioEls.length; k++) {
          if (localisationOkRadioEls[k].checked) {
            if (localisationOkRadioEls[k].value === "true") {
              locValue = true;
            } else if (localisationOkRadioEls[k].value === "false") {
              locValue = false;
            }
            break;
          }
        }
        if (typeof locValue === "boolean") {
          entry.localisation_rubric_ok = locValue;
        } else {
          delete entry.localisation_rubric_ok;
        }

        // Diagnosis rubric OK
        var diagValue = null;
        for (var gk = 0; gk < diagnosisOkRadioEls.length; gk++) {
          if (diagnosisOkRadioEls[gk].checked) {
            if (diagnosisOkRadioEls[gk].value === "true") {
              diagValue = true;
            } else if (diagnosisOkRadioEls[gk].value === "false") {
              diagValue = false;
            }
            break;
          }
        }
        if (typeof diagValue === "boolean") {
          entry.diagnosis_rubric_ok = diagValue;
        } else {
          delete entry.diagnosis_rubric_ok;
        }

        // Rubric comments
        var locCommentVal = localisationCommentEl.value;
        if (locValue === false && locCommentVal && locCommentVal.trim() !== "") {
          entry.localisation_comment = locCommentVal;
        } else {
          delete entry.localisation_comment;
        }

        var diagCommentVal = diagnosisCommentEl.value;
        if (diagValue === false && diagCommentVal && diagCommentVal.trim() !== "") {
          entry.diagnosis_comment = diagCommentVal;
        } else {
          delete entry.diagnosis_comment;
        }

        answersByCaseId[caseId] = entry;
        markDirty();
        refreshCaseListCompletion();
      }

      function switchCase(newIndex, openEuroradToo) {
        if (!cases || cases.length === 0) return;
        if (newIndex < 0 || newIndex >= cases.length) return;

        if (cases.length > 0) {
          updateAnswerFromForm();
        }

        currentIndex = newIndex;

        var caseObj = cases[currentIndex];
        var caseId = extractCaseId(caseObj.case_url, currentIndex);

        caseTitleEl.textContent = caseObj.case_title || ("Case " + caseId);
        if (caseObj.case_url) {
          caseUrlEl.textContent = caseObj.case_url;
          caseUrlEl.href = caseObj.case_url;
        } else {
          caseUrlEl.textContent = "";
          caseUrlEl.removeAttribute("href");
        }
        loadStatusEl.textContent = "";

        renderDiagnosticSteps(caseObj, caseId);
        renderImagingExaminations(caseObj, caseId);
        renderLocalisationRubric(caseObj);
        caseAnnotationsSection.style.display = "block";

        var saved = answersByCaseId[caseId];

        // restore difficulty
        var difficultyVal = "";
        if (saved && typeof saved.difficulty !== "undefined") {
          difficultyVal = saved.difficulty;
        } else if (typeof caseObj.difficulty !== "undefined") {
          difficultyVal = caseObj.difficulty || "";
        }
        difficultySelect.value = difficultyVal || "";

        // restore rarity
        var rarityVal = "";
        if (saved && typeof saved.rarity !== "undefined") {
          rarityVal = saved.rarity;
        } else if (typeof caseObj.rarity !== "undefined") {
          rarityVal = caseObj.rarity || "";
        }
        raritySelect.value = rarityVal || "";

        // restore discard
        var discardVal = undefined;
        if (saved && typeof saved.discard !== "undefined") {
          discardVal = saved.discard;
        } else if (typeof caseObj.discard !== "undefined" && caseObj.discard !== "") {
          discardVal = normalizeBoolean(caseObj.discard);
        }
        for (var dis = 0; dis < discardRadioEls.length; dis++) {
          discardRadioEls[dis].checked = (typeof discardVal === "boolean" && discardRadioEls[dis].value === (discardVal ? "true" : "false"));
        }

        // restore red flag exam
        if (saved && typeof saved.red_flag_exam !== "undefined") {
          redFlagInput.value = saved.red_flag_exam;
        } else if (typeof caseObj.red_flag_exam !== "undefined") {
          redFlagInput.value = caseObj.red_flag_exam || "";
        } else {
          redFlagInput.value = "";
        }

        // restore comment
        if (saved && typeof saved.comment !== "undefined") {
          caseCommentEl.value = saved.comment;
        } else if (typeof caseObj.comment !== "undefined") {
          caseCommentEl.value = caseObj.comment || "";
        } else {
          caseCommentEl.value = "";
        }

        // restore localisation radio + comment
        for (var r = 0; r < localisationOkRadioEls.length; r++) {
          localisationOkRadioEls[r].checked = false;
        }
        if (saved && typeof saved.localisation_rubric_ok !== "undefined") {
          var selectedValue = saved.localisation_rubric_ok ? "true" : "false";
          for (var lr = 0; lr < localisationOkRadioEls.length; lr++) {
            localisationOkRadioEls[lr].checked = (localisationOkRadioEls[lr].value === selectedValue);
          }
        }
        for (var rg = 0; rg < diagnosisOkRadioEls.length; rg++) {
          diagnosisOkRadioEls[rg].checked = false;
        }
        if (saved && typeof saved.diagnosis_rubric_ok !== "undefined") {
          var selectedDiagnosisValue = saved.diagnosis_rubric_ok ? "true" : "false";
          for (var dgr = 0; dgr < diagnosisOkRadioEls.length; dgr++) {
            diagnosisOkRadioEls[dgr].checked = (diagnosisOkRadioEls[dgr].value === selectedDiagnosisValue);
          }
        }
        if (saved && typeof saved.localisation_comment !== "undefined") {
          localisationCommentEl.value = saved.localisation_comment;
        } else {
          localisationCommentEl.value = "";
        }
        if (saved && typeof saved.diagnosis_comment !== "undefined") {
          diagnosisCommentEl.value = saved.diagnosis_comment;
        } else {
          diagnosisCommentEl.value = "";
        }

        updateRubricCommentVisibility();

        refreshCaseListCompletion();
        updateHeaderCounter();
        updatePrevNextButtonState();

        if (openEuroradToo) {
          openEuroradForCurrentCase();
        }
      }

      function updatePrevNextButtonState() {
        btnPrevCase.disabled = (currentIndex <= 0 || !cases || cases.length === 0);
        btnNextCase.disabled = (!cases || cases.length === 0 || currentIndex >= cases.length - 1);
      }

      function openEuroradForCurrentCase() {
        if (!cases || cases.length === 0) return;
        var caseObj = cases[currentIndex];
        var url = caseObj.case_url;
        if (!url) return;

        var features = "width=1200,height=800,menubar=yes,toolbar=yes,location=yes,scrollbars=yes,resizable=yes";
        if (!euroradWindow || euroradWindow.closed) {
          euroradWindow = window.open(url, "euroradWindow", features);
        } else {
          try {
            euroradWindow.location.href = url;
            euroradWindow.focus();
          } catch (e) {
            euroradWindow = window.open(url, "euroradWindow", features);
          }
        }
      }

      function exportJson() {
        if (!cases || cases.length === 0) {
          alert("No case data to export.");
          return;
        }
        updateAnswerFromForm();

        var answersArray = [];
        for (var caseId in answersByCaseId) {
          if (!Object.prototype.hasOwnProperty.call(answersByCaseId, caseId)) continue;
          var entry = answersByCaseId[caseId];
          var out = { case_id: caseId };
          if (typeof entry.difficulty !== "undefined") {
            out.difficulty = entry.difficulty;
          }
          if (typeof entry.discard !== "undefined") {
            out.discard = entry.discard;
          }
          if (typeof entry.red_flag_exam !== "undefined") {
            out.red_flag_exam = entry.red_flag_exam;
          }
          if (typeof entry.comment !== "undefined") {
            out.comment = entry.comment;
          }
          if (entry.steps_essential) {
            out.steps_essential = entry.steps_essential;
          }
          if (entry.imaging_preferred_order) {
            out.imaging_preferred_order = entry.imaging_preferred_order;
          }
          if (entry.imaging_meta_info_ok) {
            out.imaging_meta_info_ok = entry.imaging_meta_info_ok;
          }
          if (entry.imaging_meta_info_comment) {
            out.imaging_meta_info_comment = entry.imaging_meta_info_comment;
          }
          if (typeof entry.localisation_rubric_ok !== "undefined") {
            out.localisation_rubric_ok = entry.localisation_rubric_ok;
          }
          if (typeof entry.diagnosis_rubric_ok !== "undefined") {
            out.diagnosis_rubric_ok = entry.diagnosis_rubric_ok;
          }
          if (typeof entry.localisation_comment !== "undefined") {
            out.localisation_comment = entry.localisation_comment;
          }
          if (typeof entry.diagnosis_comment !== "undefined") {
            out.diagnosis_comment = entry.diagnosis_comment;
          }
          var caseObj = findCaseById(caseId);
          out.complete = isCaseComplete(entry, caseObj);
          answersArray.push(out);
        }

        var payload = {
          dataset_id: DATASET_ID,
          answers: answersArray,
          exported_at: new Date().toISOString()
        };

        var jsonStr = JSON.stringify(payload, null, 2);
        var blob = new Blob([jsonStr], { type: "application/json" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        var timestamp = new Date().toISOString().replace(/[:.]/g, "-");
        a.href = url;
        a.download = "result_" + timestamp + ".json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        dirty = false;
        autosaveStatus.textContent = "Exported JSON at " + formatTime(new Date());
      }

      function onCasesLoaded(data, sourceName) {
        if (!Array.isArray(data)) {
          alert("JSON root is not an array. Please check " + (sourceName || "the JSON file") + ".");
          return;
        }
        cases = data;
        if (!cases || cases.length === 0) {
          alert("No cases found in the JSON file.");
          return;
        }

        loadFromLocalStorage();
        buildCaseList();
        updatePrevNextButtonState();

        if (currentIndex < 0 || currentIndex >= cases.length) {
          currentIndex = 0;
        }
        switchCase(currentIndex, false);

        if (!autosaveTimerStarted) {
          setInterval(autoSaveTick, autosaveInterval);
          autosaveTimerStarted = true;
        }

        loadStatusEl.textContent =
          "Loaded " + (Array.isArray(data) ? data.length : 0) +
          " cases from " + (sourceName || "JSON") + ".";

        manualLoadContainer.style.display = "none";
        jsonLoadWarning.textContent = "";
      }

      function handleManualJsonFile(file) {
        if (!file) return;
        if (!/\.json$/i.test(file.name)) {
          jsonLoadWarning.textContent = "Please choose a .json file.";
          return;
        }
        var reader = new FileReader();
        reader.onload = function (evt) {
          try {
            var text = evt.target.result;
            var data = JSON.parse(text);
            onCasesLoaded(data, file.name);
          } catch (e) {
            console.error("Failed to parse JSON:", e);
            jsonLoadWarning.textContent = "Failed to parse JSON. Please ensure the file format matches the example.";
          }
        };
        reader.onerror = function () {
          jsonLoadWarning.textContent = "Failed to read the file.";
        };
        reader.readAsText(file, "utf-8");
      }

      function clearMemory() {
        if (!confirm("This will clear all saved answers in this browser for this dataset. Continue?")) {
          return;
        }
        try {
          window.localStorage.removeItem(STORAGE_KEY);
        } catch (e) {
          console.error("Failed to clear localStorage:", e);
        }
        answersByCaseId = {};
        dirty = false;
        autosaveStatus.textContent = "Local memory cleared at " + formatTime(new Date());

        if (cases && cases.length > 0) {
          var caseObj = cases[currentIndex];
          var caseId = extractCaseId(caseObj.case_url, currentIndex);

          // reset step essentials for current case
          var ds = caseObj.diagnostic_steps || {};
          var steps = (ds.steps && Array.isArray(ds.steps)) ? ds.steps : [];
          for (var i = 0; i < steps.length; i++) {
            var groupName = "step-priority-" + caseId + "-" + i;
            var radios = stepsListEl.querySelectorAll('input[name="' + groupName + '"]');
            for (var j = 0; j < radios.length; j++) {
              radios[j].checked = false;
            }
          }

          // reset imaging preferred order
          var exams = (caseObj.imaging_examinations && Array.isArray(caseObj.imaging_examinations)) ? caseObj.imaging_examinations : [];
          for (var e = 0; e < exams.length; e++) {
            var select = imagingListEl.querySelector('select[name="imaging-order-' + caseId + '-' + e + '"]');
            if (select) {
              select.value = "";
            }
            var metaRadios = imagingListEl.querySelectorAll('input[name="imaging-metainfo-' + caseId + '-' + e + '"]');
            for (var mr = 0; mr < metaRadios.length; mr++) {
              metaRadios[mr].checked = false;
            }
            var metaComment = imagingListEl.querySelector('textarea[name="imaging-metainfo-comment-' + caseId + '-' + e + '"]');
            if (metaComment) {
              metaComment.value = "";
              if (metaComment.parentNode) {
                metaComment.parentNode.style.display = "none";
              }
            }
          }

          // reset case-level annotations
          difficultySelect.value = "";
          raritySelect.value = "";
          for (var dis = 0; dis < discardRadioEls.length; dis++) {
            discardRadioEls[dis].checked = false;
          }
          redFlagInput.value = "";
          caseCommentEl.value = "";

          // reset localisation radios and comment
          for (var k = 0; k < localisationOkRadioEls.length; k++) {
            localisationOkRadioEls[k].checked = false;
          }
          for (var gk = 0; gk < diagnosisOkRadioEls.length; gk++) {
            diagnosisOkRadioEls[gk].checked = false;
          }
          localisationCommentEl.value = "";
          diagnosisCommentEl.value = "";
          if (imagingWarningEl) {
            imagingWarningEl.style.display = "none";
            imagingWarningEl.textContent = "";
          }
          updateRubricCommentVisibility();

          refreshCaseListCompletion();
        }
      }

      function initEventListeners() {
        btnPrevCase.addEventListener("click", function () {
          if (!cases || cases.length === 0) return;
          var target = currentIndex - 1;
          if (target >= 0) {
            switchCase(target, true);
          }
        });

        btnNextCase.addEventListener("click", function () {
          if (!cases || cases.length === 0) return;
          var target = currentIndex + 1;
          if (target < cases.length) {
            switchCase(target, true);
          }
        });

        btnOpenEurorad.addEventListener("click", function () {
          openEuroradForCurrentCase();
        });

        btnExportJson.addEventListener("click", function () {
          exportJson();
        });

        btnClearMemory.addEventListener("click", function () {
          clearMemory();
        });

        difficultySelect.addEventListener("change", function () {
          updateAnswerFromForm();
        });
        raritySelect.addEventListener("change", function () {
          updateAnswerFromForm();
        });
        redFlagInput.addEventListener("input", function () {
          updateAnswerFromForm();
        });
        caseCommentEl.addEventListener("input", function () {
          updateAnswerFromForm();
        });
        localisationCommentEl.addEventListener("input", function () {
          updateAnswerFromForm();
        });
        diagnosisCommentEl.addEventListener("input", function () {
          updateAnswerFromForm();
        });

        for (var r = 0; r < localisationOkRadioEls.length; r++) {
          localisationOkRadioEls[r].addEventListener("change", function () {
            updateAnswerFromForm();
          });
        }

        for (var dis = 0; dis < discardRadioEls.length; dis++) {
          discardRadioEls[dis].addEventListener("change", function () {
            updateAnswerFromForm();
          });
        }

        for (var dg = 0; dg < diagnosisOkRadioEls.length; dg++) {
          diagnosisOkRadioEls[dg].addEventListener("change", function () {
            updateAnswerFromForm();
          });
        }

        btnManualLoadJson.addEventListener("click", function () {
          jsonFileInput.value = "";
          jsonFileInput.click();
        });

        jsonFileInput.addEventListener("change", function (evt) {
          var file = evt.target.files && evt.target.files[0];
          handleManualJsonFile(file);
        });
      }

      function init() {
        updatePrevNextButtonState();
        initEventListeners();
        // On GitHub / any web server, we do NOT auto-fetch a JSON file.
        // The user must explicitly choose a local JSON file via the button.
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
